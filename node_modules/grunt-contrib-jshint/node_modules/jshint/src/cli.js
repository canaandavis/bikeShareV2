function deprecated(e,t){return t?e+" (DEPRECATED, use "+t+" instead)":e+" (DEPRECATED)"}function findConfig(e){var t=path.dirname(path.resolve(e)),n=getHomeDir();if(!n)return r;var r=path.normalize(path.join(n,".jshintrc")),i=findFile(".jshintrc",t);return i?i:shjs.test("-e",r)?r:null}function getHomeDir(){var e=global.process.env,t=[e.HOME,e.USERPROFILE,e.HOMEPATH,e.HOMEDRIVE+e.HOMEPATH];for(var n in t)if(t.hasOwnProperty(n)){var r=t[n];if(r&&fs.existsSync(r))return r}}function loadNpmConfig(e){var t=path.dirname(path.resolve(e)),n=findFile("package.json",t);if(!n)return null;try{return require(n).jshintConfig}catch(r){return null}}function loadReporter(e){try{return require(e).reporter}catch(t){return null}}function findFile(e,t){t=t||process.cwd();var n=path.normalize(path.join(t,e));if(findFileResults[n]!==undefined)return findFileResults[n];var r=path.resolve(t,"../");return shjs.test("-e",n)?(findFileResults[n]=n,n):t===r?(findFileResults[n]=null,null):findFile(e,r)}function loadIgnores(e,t){var n=findFile(t||".jshintignore");if(!n&&!e)return[];var r=(n?shjs.cat(n):"").split("\n");return r.unshift(e||""),r.filter(function(e){return!!e.trim()}).map(function(e){return e[0]==="!"?"!"+path.resolve(path.dirname(n),e.substr(1).trim()):path.join(path.dirname(n),e.trim())})}function isIgnored(e,t){return t.some(function(t){if(minimatch(path.resolve(e),t,{nocase:!0}))return!0;if(path.resolve(e)===t)return!0;if(shjs.test("-d",e)&&t.match(/^[^\/]*\/?$/)&&e.match(new RegExp("^"+t+".*")))return!0})}function extract(e,t){function o(t,o){if(t!=="script")return;if(o.type&&!/text\/javascript/.test(o.type.toLowerCase()))return;n=!0,i.push.apply(i,e.slice(r,f.endIndex).match(/\n\r|\n|\r/g)),s=null}function u(e){if(e!=="script"||!n)return;n=!1,r=f.startIndex,s=null}function a(e){if(!n)return;var t=e.split(/\n\r|\n|\r/);s||t.some(function(e){if(!e)return;return s=/^(\s*)/.exec(e)[1],!0}),s&&(t=t.map(function(e){return e.replace(s,"")}),e=t.join("\n")),i.push(e)}if(t==="always"||t==="auto"&&!!/^\s*</.test(e)){var n=!1,r=0,i=[],s,f=new htmlparser.Parser({onopentag:o,onclosetag:u,ontext:a});return f.parseComplete(e),i.join("")}return e}function extractOffsets(e,t){function u(t,o){if(t!=="script")return;if(o.type&&!/text\/javascript/.test(o.type.toLowerCase()))return;n=!0;var u=e.slice(r,l.endIndex),a=u.match(/\n\r|\n|\r/g).length;i+=a,s=null}function a(e){if(e!=="script"||!n)return;n=!1,r=l.startIndex,s=null}function f(e){if(!n)return;var t=e.split(/\n\r|\n|\r/);s||t.some(function(e){if(!e)return;return s=/^(\s*)/.exec(e)[1],!0}),t.forEach(function(){i+=1,s?o[i]=s.length:o[i]=0})}if(t==="always"||t==="auto"&&!!/^\s*</.test(e)){var n=!1,r=0,i=0,s,o=[],l=new htmlparser.Parser({onopentag:u,onclosetag:a,ontext:f});return l.parseComplete(e),o}return}function collect(e,t,n,r){if(n&&isIgnored(e,n))return;if(!shjs.test("-e",e)){cli.error("Can't open "+e);return}if(shjs.test("-d",e)){shjs.ls(e).forEach(function(i){var s=path.join(e,i);(shjs.test("-d",s)||i.match(r))&&collect(s,t,n,r)});return}t.push(e)}function lint(e,t,n,r,i){var s,o,u=[];n=n||{},n=JSON.parse(JSON.stringify(n)),n.prereq&&(n.prereq.forEach(function(e){e=path.join(n.dirname,e),shjs.test("-e",e)&&u.push(shjs.cat(e))}),delete n.prereq),n.globals&&(s=n.globals,delete n.globals),n.overrides&&(i&&_.each(n.overrides,function(e,t){minimatch(i,t,{nocase:!0,matchBase:!0})&&(e.globals&&(s=_.extend(s||{},e.globals),delete e.globals),_.extend(n,e))}),delete n.overrides),delete n.dirname,u.push(e),u=u.join("\n"),u=u.replace(/^\uFEFF/,""),JSHINT(u,n,s)||JSHINT.errors.forEach(function(e){e&&t.push({file:i||"stdin",error:e})}),o=JSHINT.data(),o&&(o.file=i||"stdin",r.push(o))}var _=require("underscore"),fs=require("fs"),cli=require("cli"),path=require("path"),shjs=require("shelljs"),minimatch=require("minimatch"),htmlparser=require("htmlparser2"),exit=require("exit"),stripJsonComments=require("strip-json-comments"),JSHINT=require("./jshint.js").JSHINT,defReporter=require("./reporters/default").reporter,OPTIONS={config:["c","Custom configuration file","string",!1],reporter:["reporter","Custom reporter (<PATH>|jslint|checkstyle)","string",undefined],exclude:["exclude","Exclude files matching the given filename pattern (same as .jshintignore)","string",null],"exclude-path":["exclude-path","Pass in a custom jshintignore file path","string",null],filename:["filename","Pass in a filename when using STDIN to emulate config lookup for that file name","string",null],verbose:["verbose","Show message codes"],"show-non-errors":["show-non-errors","Show additional data generated by jshint"],"extra-ext":["e","Comma-separated list of file extensions to use (default is .js)","string",""],extract:["extract","Extract inline scripts contained in HTML (auto|always|never, default to never)","string","never"],"jslint-reporter":["jslint-reporter",deprecated("Use a jslint compatible reporter","--reporter=jslint")],"checkstyle-reporter":["checkstyle-reporter",deprecated("Use a CheckStyle compatible XML reporter","--reporter=checkstyle")]},findFileResults={},exports={extract:extract,exit:exit,getConfig:function(e){return loadNpmConfig(e)||exports.loadConfig(findConfig(e))},loadConfig:function(e){if(!e)return{};shjs.test("-e",e)||(cli.error("Can't find config file: "+e),exports.exit(1));try{var t=JSON.parse(stripJsonComments(shjs.cat(e)));t.dirname=path.dirname(e);if(t["extends"]){var n=exports.loadConfig(path.resolve(t.dirname,t["extends"]));t.globals=_.extend({},n.globals,t.globals),_.defaults(t,n),delete t["extends"]}return t}catch(r){cli.error("Can't parse config file: "+e),exports.exit(1)}},gather:function(e){var t=[],n=new RegExp("\\.(js"+(e.extensions?"|"+e.extensions.replace(/,/g,"|").replace(/[\. ]/g,""):"")+")$"),r=e.ignores?e.ignores.map(function(e){return path.resolve(e)}):loadIgnores();return e.args.forEach(function(e){collect(e,t,r,n)}),t},run:function(e,t){var n=exports.gather(e),r=[],i=[];return e.useStdin?(cli.withStdin(function(n){var s=e.config;if(e.filename&&!s){var o=path.resolve(e.filename);s=loadNpmConfig(o)||exports.loadConfig(findConfig(o))}s=s||{},lint(extract(n,e.extract),r,s,i),(e.reporter||defReporter)(r,i,{verbose:e.verbose}),t(r.length===0)}),null):(n.forEach(function(t){var n=e.config||exports.getConfig(t),s;try{s=shjs.cat(t)}catch(o){cli.error("Can't open "+t),exports.exit(1)}lint(extract(s,e.extract),r,n,i,t);if(r.length){var u=extractOffsets(s,e.extract);u&&u.length&&r.forEach(function(e){var t=e.error.line;if(t>=0&&t<u.length){var n=+u[t];e.error.character+=n}})}}),(e.reporter||defReporter)(r,i,{verbose:e.verbose}),r.length===0)},getBufferSize:function(){return process.stdout.bufferSize},interpret:function(e){function i(e){if(e==null)return;exports.exit(e?0:2)}cli.setArgv(e),cli.options={},cli.enable("version","glob","help"),cli.setApp(path.resolve(__dirname+"/../package.json"));var t=cli.parse(OPTIONS),n;t.config&&(n=exports.loadConfig(t.config));switch(!0){case t.reporter==="jslint":case t["jslint-reporter"]:t.reporter="./reporters/jslint_xml.js";break;case t.reporter==="checkstyle":case t["checkstyle-reporter"]:t.reporter="./reporters/checkstyle.js";break;case t["show-non-errors"]:t.reporter="./reporters/non_error.js";break;case t.reporter!==undefined:t.reporter=path.resolve(process.cwd(),t.reporter)}var r;t.reporter&&(r=loadReporter(t.reporter),r===null&&(cli.error("Can't load reporter file: "+t.reporter),exports.exit(1))),i(exports.run({args:cli.args,config:n,reporter:r,ignores:loadIgnores(t.exclude,t["exclude-path"]),extensions:t["extra-ext"],verbose:t.verbose,extract:t.extract,filename:t.filename,useStdin:{"-":!0,"/dev/stdin":!0}[e[e.length-1]]},i))}};module.exports=exports;