/**
 * Copyright (c) 2010 Chris O'Hara <cohara87@gmail.com>
 *
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the
 * "Software"), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish,
 * distribute, sublicense, and/or sell copies of the Software, and to
 * permit persons to whom the Software is furnished to do so, subject to
 * the following conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */

//license information for either - contact me if you want your license added

var cli=exports,argv,curr_opt,curr_val,full_opt,is_long,short_tags=[],opt_list,parsed={},usage,argv_parsed,command_list,commands,daemon,daemon_arg,no_color,show_debug;cli.app=null,cli.version=null,cli.argv=[],cli.argc=0,cli.options={},cli.args=[],cli.command,cli.width=70,cli.option_width=25,cli.native={};var define_native=function(e){Object.defineProperty(cli.native,e,{enumerable:!0,configurable:!0,get:function(){return delete cli.native[e],cli.native[e]=require(e)}})},natives=process.binding("natives");for(var module in natives)define_native(module);cli.output=cli.native.util.print,cli.exit=require("exit");var enable={help:!0,version:!1,daemon:!1,status:!1,timeout:!1,catchall:!1,glob:!1};cli.enable=function(){return Array.prototype.slice.call(arguments).forEach(function(e){switch(e){case"daemon":try{daemon=require("daemon");if(typeof daemon.daemonize!="function")throw"Invalid module"}catch(t){cli.fatal("daemon.node not installed. Please run `npm install daemon`")}break;case"catchall":process.on("uncaughtException",function(e){cli.error("Uncaught exception: "+(e.msg||e))});break;case"help":case"version":case"status":case"autocomplete":case"timeout":break;case"glob":cli.glob=require("glob");break;default:cli.fatal('Unknown plugin "'+e+'"')}enable[e]=!0}),cli},cli.disable=function(){return Array.prototype.slice.call(arguments).forEach(function(e){enable[e]&&(enable[e]=!1)}),cli},cli.setArgv=function(e,t){typeof e=="string"?e=e.split(" "):e=e.slice(),cli.app=e.shift(),!t&&("node"===cli.native.path.basename(cli.app)||cli.native.path.basename(process.execPath)===cli.app||process.execPath===cli.app)&&(cli.app=e.shift()),cli.app=cli.native.path.basename(cli.app),argv_parsed=!1,cli.args=cli.argv=argv=e,cli.argc=argv.length,cli.options={},cli.command=null},cli.setArgv(process.argv),cli.next=function(){argv_parsed||(cli.args=[],argv_parsed=!0),curr_val=null;if(short_tags.length)return curr_opt=short_tags.shift(),full_opt="-"+curr_opt,curr_opt;if(!argv.length)return!1;curr_opt=argv.shift();if(curr_opt==="-"||curr_opt==="--"){while(argv.length)cli.args.push(argv.shift());return!1}if(curr_opt[0]!=="-")return cli.args.push(curr_opt),cli.next();is_long=curr_opt[1]==="-",curr_opt=curr_opt.substr(is_long?2:1);if(!is_long&&curr_opt.length>1)return short_tags=curr_opt.split(""),cli.next();var e,t;if(is_long&&(e=curr_opt.indexOf("="))>=0){curr_val=curr_opt.substr(e+1),curr_opt=curr_opt.substr(0,e),t=curr_val.length;if(curr_val[0]==='"'&&curr_val[t-1]==='"'||curr_val[0]==="'"&&curr_val[t-1]==="'")curr_val=curr_val.substr(1,t-2);curr_val.match(/^[0-9]+$/)&&(curr_val=parseInt(curr_val,10))}return full_opt=(is_long?"--":"-")+curr_opt,curr_opt},cli.parse=function(e,t){var n,r,i=cli.options,s,u=!e;opt_list=e||{},commands=t,command_list=commands||[],commands&&!Array.isArray(commands)&&(command_list=Object.keys(commands));while(o=cli.next()){s=!1;for(opt in opt_list){if(!(opt_list[opt]instanceof Array))continue;opt_list[opt][0]||(opt_list[opt][0]=opt);if(o===opt||o===opt_list[opt][0]){s=!0;if(opt_list[opt].length===2){i[opt]=!0;break}n=null,opt_list[opt].length===4&&(n=opt_list[opt][3]);if(opt_list[opt][2]instanceof Array){for(r=0,l=opt_list[opt][2].length;r<l;r++)typeof opt_list[opt][2][r]=="number"&&(opt_list[opt][2][r]+="");i[opt]=cli.getArrayValue(opt_list[opt][2],is_long?null:n);break}opt_list[opt][2].toLowerCase&&(opt_list[opt][2]=opt_list[opt][2].toLowerCase());switch(opt_list[opt][2]){case"string":case 1:case!0:i[opt]=cli.getValue(n);break;case"int":case"number":case"num":case"time":case"seconds":case"secs":case"minutes":case"mins":case"x":case"n":i[opt]=cli.getInt(n);break;case"float":case"decimal":i[opt]=cli.getFloat(n);break;case"path":case"file":case"directory":case"dir":i[opt]=cli.getPath(n,opt_list[opt][2]);break;case"email":i[opt]=cli.getEmail(n);break;case"url":case"uri":case"domain":case"host":i[opt]=cli.getUrl(n,opt_list[opt][2]);break;case"ip":i[opt]=cli.getIp(n);break;case"bool":case"boolean":case"on":i[opt]=!0;break;case"false":case"off":case!1:case 0:i[opt]=!1;break;default:cli.fatal('Unknown opt type "'+opt_list[opt][2]+'"')}break}}process.env.NODE_DISABLE_COLORS&&(no_color=!0);if(!s){if(!enable.help||o!=="h"&&o!=="help"){if(!(!enable.version||o!=="v"&&o!=="version")){cli.version==null&&cli.parsePackageJson(),console.error(cli.app+" v"+cli.version),cli.exit();break}if(!(!enable.daemon||o!=="d"&&o!=="daemon")){daemon_arg=cli.getArrayValue(["start","stop","restart","pid","log"],is_long?null:"start");continue}if(!(!enable.catchall||o!=="c"&&o!=="catch"))continue;if(!(!enable.status||o!=="k"&&o!=="no-color"&&o!=="debug")){no_color=o==="k"||o==="no-color",show_debug=o==="debug";continue}if(!(!enable.timeout||o!=="t"&&o!=="timeout")){var a=cli.getInt();setTimeout(function(){cli.fatal("Process timed out after "+a+"s")},a*1e3);continue}if(u){i[o]=curr_val||!0;continue}}else cli.getUsage();cli.fatal("Unknown option "+full_opt)}}for(opt in opt_list){n=opt_list[opt].length===4?opt_list[opt][3]:null;if(!(opt_list[opt]instanceof Array)){i[opt]=opt_list[opt];continue}typeof i[opt]=="undefined"&&(i[opt]=n)}if(command_list.length){if(cli.args.length===0)return enable.help?cli.getUsage():cli.fatal("A command is required ("+command_list.join(", ")+")."),cli.exit(1);cli.command=cli.autocompleteCommand(cli.args.shift())}return cli.argc=cli.args.length,i},cli.autocompleteCommand=function(e){var t;command_list instanceof Array?t=command_list:t=Object.keys(command_list);var n,r=0,i=e.length,s;if(t.length===0||t.indexOf(e)!==-1)return e;for(n=0;n<i;n++){s=[],l=t.length;if(l<=1)break;for(r=0;r<l;r++)t[r].length>=n&&t[r][n]===e[n]&&s.push(t[r]);t=s}l=t.length;if(l===1)return t[0];l===0?cli.fatal('Unknown command "'+e+'"'+(enable.help?". Please see --help for more information":"")):(t.sort(),cli.fatal('The command "'+e+'" is ambiguous and could mean "'+t.join('", "')+'"'))},cli.status=function(e,t){var n;switch(t){case"info":n=no_color?"INFO:":"[33mINFO[0m:";break;case"debug":n=no_color?"DEBUG:":"[36mDEBUG[0m:";break;case"error":case"fatal":n=no_color?"ERROR:":"[31mERROR[0m:";break;case"ok":n=no_color?"OK:":"[32mOK[0m:"}e=n+" "+e;if(t==="fatal")return console.error(e),cli.exit(1);if(enable.status&&!show_debug&&t==="debug")return;console.error(e)},["info","error","ok","debug","fatal"].forEach(function(e){cli[e]=function(t){cli.status(t,e)}}),cli.setApp=function(e,t){return e.indexOf("package.json")!==-1?cli.parsePackageJson(e):(cli.app=e,cli.version=t),cli},cli.parsePackageJson=function(e){var t=function(e){var t=JSON.parse(cli.native.fs.readFileSync(e,"utf8"));cli.version=t.version,cli.app=t.name},n=function(e,t,n){for(var r=0,i=e.length;r<i;r++)try{t(e[r]);return}catch(s){r===i-1&&cli.fatal(n)}};try{if(e)return t(e);n([__dirname+"/package.json",__dirname+"/../package.json",__dirname+"/../../package.json"],t)}catch(r){cli.fatal("Could not detect "+cli.app+" version")}},cli.setUsage=function(e){return usage=e,cli};var pad=function(e,t){typeof t=="undefined"&&(t=e,e="");if(e.length<t){t-=e.length;while(t--)e+=" "}return e};cli.getUsage=function(e){var t,n,r,i,s=[],o=cli.option_width,u=function(e,t,n){var r=e.length,i=cli.width-r,s="";if(t.length<=i)return t;var o=(t+"").split(" "),u=0,a;while(o.length)s+=(a=o.shift())+" ",u+=a.length,o.length&&u+o[0].length>i&&(s+="\n"+pad(r),u=0);return s};usage=usage||cli.app+" [OPTIONS]"+(command_list.length?" <command>":"")+" [ARGS]",no_color?(console.error("Usage:\n  "+usage),console.error("Options: ")):(console.error("[1mUsage[0m:\n  "+usage),console.error("\n[1mOptions[0m: "));for(opt in opt_list){opt.length===1?(long=opt_list[opt][0],t=opt):(long=opt,t=opt_list[opt][0]),n=opt_list[opt][1].trim(),type=opt_list[opt].length>=3?opt_list[opt][2]:null,r=opt_list[opt].length===4?opt_list[opt][3]:null,t===long?t.length===1?i="  -"+t:i="      --"+long:t?i="  -"+t+", --"+long:i="      --"+long,i+=" ";if(type){type instanceof Array&&(n+=". VALUE must be either ["+type.join("|")+"]",type="VALUE");if(type===!0||type===1)type=long.toUpperCase();type=type.toUpperCase();if(type==="FLOAT"||type==="INT")type="NUMBER";i+=r?"["+type+"]":type}i=pad(i,o),i+=u(i,n),i+=r?" (Default is "+r+")":"",console.error(i.replace("%s","%\0s")),s.push(t),s.push(long)}enable.timeout&&s.indexOf("t")===-1&&s.indexOf("timeout")===-1&&console.error(pad("  -t, --timeout N",o)+"Exit if the process takes longer than N seconds"),enable.status&&(s.indexOf("k")===-1&&s.indexOf("no-color")===-1&&console.error(pad("  -k, --no-color",o)+"Omit color from output"),s.indexOf("debug")===-1&&console.error(pad("      --debug",o)+"Show debug information")),enable.catchall&&s.indexOf("c")===-1&&s.indexOf("catch")===-1&&console.error(pad("  -c, --catch",o)+"Catch unanticipated errors"),enable.daemon&&s.indexOf("d")===-1&&s.indexOf("daemon")===-1&&console.error(pad("  -d, --daemon [ARG]",o)+"Daemonize the process. Control the daemon using [start, stop, restart, log, pid]"),enable.version&&s.indexOf("v")===-1&&s.indexOf("version")===-1&&console.error(pad("  -v, --version",o)+"Display the current version"),enable.help&&s.indexOf("h")===-1&&s.indexOf("help")===-1&&console.error(pad("  -h, --help",o)+"Display help and usage details");if(command_list.length){console.error("\n[1mCommands[0m: ");if(!Array.isArray(commands))for(var a in commands)i="  "+pad(a,o-2),i+=u(i,commands[a]),console.error(i);else command_list.sort(),console.error("  "+u("  ",command_list.join(", ")))}return cli.exit(e)},cli.getOptError=function(e,t){var n=full_opt+" expects "+e+". Use `"+cli.app+" "+full_opt+(is_long?"=":" ")+t+"`";return n},cli.getValue=function(e,t,n){n=n||cli.getOptError("a value","VALUE");var r;try{if(curr_val)return t&&(curr_val=t(curr_val)),curr_val;if(short_tags.length)throw"Short tags";if(!argv.length||argv[0].length===1&&argv[0][0]==="-")throw"No value";r=argv.shift(),r.match(/^[0-9]+$/)&&(r=parseInt(r,10)),t&&(r=t(r))}catch(i){return r&&argv.unshift(r),e!=null?e:cli.fatal(n)}return r},cli.getInt=function(e){return cli.getValue(e,function(e){if(typeof e=="number")return e;if(!e.match(/^(?:-?(?:0|[1-9][0-9]*))$/))throw"Invalid int";return parseInt(e)},cli.getOptError("a number","NUMBER"))},cli.getFloat=function(e){return cli.getValue(e,function(e){if(!e.match(/^(?:-?(?:0|[1-9][0-9]*))?(?:\.[0-9]*)?$/))throw"Invalid float";return parseFloat(e,10)},cli.getOptError("a number","NUMBER"))},cli.getUrl=function(e,t){return t=t||"url",cli.getValue(e,function(e){if(!e.match(/^(?:(?:ht|f)tp(?:s?)\:\/\/|~\/|\/)?(?:\w+:\w+@)?((?:(?:[-\w\d{1-3}]+\.)+(?:com|org|net|gov|mil|biz|info|mobi|name|aero|jobs|edu|co\.uk|ac\.uk|it|fr|tv|museum|asia|local|travel|[a-z]{2})?)|((\b25[0-5]\b|\b[2][0-4][0-9]\b|\b[0-1]?[0-9]?[0-9]\b)(\.(\b25[0-5]\b|\b[2][0-4][0-9]\b|\b[0-1]?[0-9]?[0-9]\b)){3}))(?::[\d]{1,5})?(?:(?:(?:\/(?:[-\w~!$+|.,=]|%[a-f\d]{2})+)+|\/)+|\?|#)?(?:(?:\?(?:[-\w~!$+|.,*:]|%[a-f\d{2}])+=?(?:[-\w~!$+|.,*:=]|%[a-f\d]{2})*)(?:&(?:[-\w~!$+|.,*:]|%[a-f\d{2}])+=?(?:[-\w~!$+|.,*:=]|%[a-f\d]{2})*)*)*(?:#(?:[-\w~!$ |\/.,*:;=]|%[a-f\d]{2})*)?$/i))throw"Invalid URL";return e},cli.getOptError("a "+t,t.toUpperCase()))},cli.getEmail=function(e){return cli.getValue(e,function(e){if(!e.match(/^(?:[\w\!\#\$\%\&\'\*\+\-\/\=\?\^\`\{\|\}\~]+\.)*[\w\!\#\$\%\&\'\*\+\-\/\=\?\^\`\{\|\}\~]+@(?:(?:(?:[a-zA-Z0-9](?:[a-zA-Z0-9\-](?!\.)){0,61}[a-zA-Z0-9]?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9\-](?!$)){0,61}[a-zA-Z0-9]?)|(?:\[(?:(?:[01]?\d{1,2}|2[0-4]\d|25[0-5])\.){3}(?:[01]?\d{1,2}|2[0-4]\d|25[0-5])\]))$/))throw"Invalid email";return e},cli.getOptError("an email","EMAIL"))},cli.getIp=function(e){return cli.getValue(e,function(e){if(!e.match(/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/))throw"Invalid IP";return e},cli.getOptError("an IP","IP"))},cli.getPath=function(e,t){return t=t||"path",cli.getValue(e,function(e){if(e.match(/[?*;{}]/))throw"Invalid path";return e},cli.getOptError("a "+t,t.toUpperCase()))},cli.getArrayValue=function(e,t){return cli.getValue(t,function(t){if(e.indexOf(t)===-1)throw"Unexpected value";return t},cli.getOptError("either ["+e.join("|")+"]","VALUE"))},cli.withStdin=function(e,t){typeof e=="function"&&(t=e,e="utf8");var n=process.openStdin(),r="";n.setEncoding(e),n.on("data",function(e){r+=e}),n.on("end",function(){t.apply(cli,[r])})},cli.withStdinLines=function(e){cli.withStdin(function(t){var n=t.indexOf("\r\n")!==-1?"\r\n":"\n";e.apply(cli,[t.split(n),n])})},cli.withInput=function(e,t,n){typeof t=="function"?(n=t,t="utf8"):typeof e=="function"&&(n=e,t="utf8",e="stdin");if(e==="stdin")e=process.openStdin();else try{e=cli.native.fs.createReadStream(e),e.on("error",cli.fatal)}catch(r){return cli.fatal(r)}e.setEncoding(t);var i=[],s="",o,u;e.on("data",function(e){if(o)return;s+=e;if(!u)if(s.indexOf("\r\n")!==-1)u="\r\n";else{if(s.indexOf("\n")===-1){last_line=s;return}u="\n"}i=s.split(u),s=o?null:i.pop();while(i.length)n.apply(cli,[i.shift(),u,!1])}),e.on("end",function(){o=!0,s.length&&n.apply(cli,[s,u||"",!1]),n.apply(cli,[null,null,!0])})},cli.daemon=function(e,t){typeof daemon=="undefined"&&cli.fatal("Daemon is not initialized"),typeof e=="function"&&(t=e,e="start");var n="/tmp/"+cli.app+".pid",r="/tmp/"+cli.app+".log",i=function(){daemon.daemonize(r,n,function(e){if(e)return cli.error("Error starting daemon: "+e);t()})},s=function(){try{cli.native.fs.readFileSync(n)}catch(e){return cli.error("Daemon is not running")}daemon.kill(n,function(e,t){if(e&&e.errno===3)return cli.error("Daemon is not running");if(e)return cli.error("Error stopping daemon: "+e.errno);cli.ok("Successfully stopped daemon with pid: "+t)})};switch(e){case"stop":s();break;case"restart":daemon.stop(n,function(){i()});break;case"log":try{cli.native.fs.createReadStream(r,{encoding:"utf8"}).pipe(process.stdout)}catch(o){return cli.error("No daemon log file")}break;case"pid":try{var u=cli.native.fs.readFileSync(n,"utf8");cli.native.fs.statSync("/proc/"+u),cli.info(u)}catch(o){return cli.error("Daemon is not running")}break;default:i()}},cli.main=function(e){var t=function(){e.apply(cli,[cli.args,cli.options])};enable.daemon&&daemon_arg?cli.daemon(daemon_arg,t):t()},cli.createServer=function(){var e=function(e,t,n){if(n)return console.error(n.stack),t.writeHead(500,{"Content-Type":"text/plain"}),t.end(n.stack+"\n");t.writeHead(404,{"Content-Type":"text/plain"}),t.end("Not Found\n")},t=error=e,n=Array.prototype.slice.call(arguments);return n.length&&n[0]instanceof Array&&(n=n[0]),n.reverse().forEach(function(e){var n=t;t=function(t,r){try{e(t,r,function(e){if(e)return error(t,r,e);n(t,r)})}catch(i){error(t,r,i)}}}),cli.native.http.createServer(t)},cli.exec=function(e,t,n){cli.native.child_process.exec(e,function(e,r,i){e=e||i;if(e)return n?n(e,r):cli.fatal("exec() failed\n"+e);t&&t(r.split("\n"))})};var last_progress_call,progress_len=74;cli.progress=function(e,t){if(e<0||e>1||isNaN(e))return;t||(t=0);var n=(new Date).getTime();if(last_progress_call&&n-last_progress_call<100&&e!==1)return;last_progress_call=n;var r=Math.floor(progress_len*e),i="";r==0&&e>0&&(r=1);for(var s=1;s<=progress_len;s++)i+=s<=r?"#":" ";var o=Math.pow(10,t),u=Math.floor(e*100*o)/o+"%";for(s=0;s<t;s++)u+=" ";cli.native.util.print("["+i+"] "+u+(e===1?"\n":"\r"))};var spinnerInterval;cli.spinner=function(e,t){if(t)return cli.native.util.print("\r"+e),clearInterval(spinnerInterval);e=e+" "||"";var n=["-","\\","|","/"],r=0,i=n.length;spinnerInterval=setInterval(function(){cli.native.util.print("\r"+e+n[r++]),r==i&&(r=0)},200)};