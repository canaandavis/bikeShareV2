/*
 * gaze
 * https://github.com/shama/gaze
 *
 * Copyright (c) 2013 Kyle Robinson Young
 * Licensed under the MIT license.
 */

function Gaze(e,t,n){var r=this;return EE.call(r),typeof t=="function"&&(n=t,t={}),t=t||{},t.mark=!0,t.interval=t.interval||100,t.debounceDelay=t.debounceDelay||500,t.cwd=t.cwd||process.cwd(),this.options=t,n=n||function(){},this._watched=Object.create(null),this._watchers=Object.create(null),this._pollers=Object.create(null),this._patterns=[],this._cached=Object.create(null),this.options.maxListeners&&(this.setMaxListeners(this.options.maxListeners),Gaze.super_.prototype.setMaxListeners(this.options.maxListeners),delete this.options.maxListeners),e&&this.add(e,n),this._keepalive=setInterval(function(){},200),this}var util=require("util"),EE=require("events").EventEmitter,fs=require("fs"),path=require("path"),globule=require("globule"),helper=require("./helper"),setImmediate=require("timers").setImmediate;typeof setImmediate!="function"&&(setImmediate=process.nextTick);var delay=10;util.inherits(Gaze,EE),module.exports=function(t,n,r){return new Gaze(t,n,r)},module.exports.Gaze=Gaze,Gaze.prototype.emit=function(){var e=this,t=arguments,n=t[0],r=t[1],i;if(n.slice(-2)!=="ed")return Gaze.super_.prototype.emit.apply(e,t),this;n==="added"&&Object.keys(this._cached).forEach(function(r){if(e._cached[r].indexOf("deleted")!==-1)return t[0]=n="renamed",[].push.call(t,r),delete e._cached[r],!1});var s=this._cached[r]||[];return s.indexOf(n)===-1&&(helper.objectPush(e._cached,r,n),clearTimeout(i),i=setTimeout(function(){delete e._cached[r]},this.options.debounceDelay),Gaze.super_.prototype.emit.apply(e,t),Gaze.super_.prototype.emit.apply(e,["all",n].concat([].slice.call(t,1)))),n==="added"&&helper.isDir(r)&&fs.readdirSync(r).map(function(e){return path.join(r,e)}).filter(function(t){return globule.isMatch(e._patterns,t,e.options)}).forEach(function(t){e.emit("added",t)}),this},Gaze.prototype.close=function(e){var t=this;return e=e===!1?!1:!0,Object.keys(t._watchers).forEach(function(e){t._watchers[e].close()}),t._watchers=Object.create(null),Object.keys(this._watched).forEach(function(e){t._unpollDir(e)}),e&&(t._watched=Object.create(null),setTimeout(function(){t.emit("end"),t.removeAllListeners(),clearInterval(t._keepalive)},delay+100)),t},Gaze.prototype.add=function(e,t){typeof e=="string"&&(e=[e]),this._patterns=helper.unique.apply(null,[this._patterns,e]),e=globule.find(this._patterns,this.options),this._addToWatched(e),this.close(!1),this._initWatched(t)},Gaze.prototype._internalAdd=function(e,t){var n=[];helper.isDir(e)?n=[helper.markDir(e)].concat(globule.find(this._patterns,this.options)):globule.isMatch(this._patterns,e,this.options)&&(n=[e]),n.length>0&&(this._addToWatched(n),this.close(!1),this._initWatched(t))},Gaze.prototype.remove=function(e){var t=this;return this._watched[e]?(this._unpollDir(e),delete this._watched[e]):Object.keys(this._watched).forEach(function(n){var r=t._watched[n].indexOf(e);if(r!==-1)return t._unpollFile(e),t._watched[n].splice(r,1),!1}),this._watchers[e]&&this._watchers[e].close(),this},Gaze.prototype.watched=function(){return this._watched},Gaze.prototype.relative=function(e,t){var n=this,r=Object.create(null),i,s,o,u=this.options.cwd||process.cwd();return e===""&&(e="."),e=helper.markDir(e),t=t||!1,Object.keys(this._watched).forEach(function(e){i=path.relative(u,e)+path.sep,i===path.sep&&(i="."),o=t?helper.unixifyPathSep(i):i,r[o]=n._watched[e].map(function(e){return s=path.relative(path.join(u,i)||"",e||""),helper.isDir(e)&&(s=helper.markDir(s)),t&&(s=helper.unixifyPathSep(s)),s})}),e&&t&&(e=helper.unixifyPathSep(e)),e?r[e]||[]:r},Gaze.prototype._addToWatched=function(e){for(var t=0;t<e.length;t++){var n=e[t],r=path.resolve(this.options.cwd,n),i=helper.isDir(n)?r:path.dirname(r);i=helper.markDir(i),helper.isDir(n)&&!(r in this._watched)&&helper.objectPush(this._watched,r,[]),n.slice(-1)==="/"&&(r+=path.sep),helper.objectPush(this._watched,path.dirname(r)+path.sep,r);var s=fs.readdirSync(i);for(var o=0;o<s.length;o++){var u=path.join(i,s[o]);fs.statSync(u).isDirectory()&&helper.objectPush(this._watched,i,u+path.sep)}}return this},Gaze.prototype._watchDir=function(e,t){var n=this,r;try{this._watchers[e]=fs.watch(e,function(i){clearTimeout(r),r=setTimeout(function(){e in n._watchers&&fs.existsSync(e)&&t(null,e)},delay+100)})}catch(i){return this._handleError(i)}return this},Gaze.prototype._unpollFile=function(e){return this._pollers[e]&&(fs.unwatchFile(e,this._pollers[e]),delete this._pollers[e]),this},Gaze.prototype._unpollDir=function(e){this._unpollFile(e);for(var t=0;t<this._watched[e].length;t++)this._unpollFile(this._watched[e][t])},Gaze.prototype._pollFile=function(e,t){var n={persistent:!0,interval:this.options.interval};if(!this._pollers[e]){this._pollers[e]=function(n,r){t(null,e)};try{fs.watchFile(e,n,this._pollers[e])}catch(r){return this._handleError(r)}}return this},Gaze.prototype._initWatched=function(e){var t=this,n=this.options.cwd||process.cwd(),r=Object.keys(t._watched);if(r.length<1){setImmediate(function(){t.emit("ready",t),e&&e.call(t,null,t),t.emit("nomatch")});return}helper.forEachSeries(r,function(e,r){e=e||"";var i=t._watched[e];t._watchDir(e,function(r,i){var s=n===e?".":path.relative(n,e);s=s||"",fs.readdir(i,function(n,r){if(n)return t.emit("error",n);if(!r)return;try{r=r.map(function(t){return fs.existsSync(path.join(e,t))&&fs.statSync(path.join(e,t)).isDirectory()?t+path.sep:t})}catch(n){}var i=t.relative(s);i.filter(function(e){return r.indexOf(e)<0}).forEach(function(n){if(!helper.isDir(n)){var r=path.join(e,n);t.remove(r),t.emit("deleted",r)}}),r.filter(function(e){return i.indexOf(e)<0}).forEach(function(n){var r=path.join(s,n);t._internalAdd(r,function(){t.emit("added",path.join(e,n))})})})}),i.forEach(function(e){if(helper.isDir(e))return;t._pollFile(e,function(e,n){fs.existsSync(n)&&t.emit("changed",n)})}),r()},function(){setTimeout(function(){t.emit("ready",t),e&&e.call(t,null,t)},delay+100)})},Gaze.prototype._handleError=function(e){return e.code==="EMFILE"?this.emit("error",new Error("EMFILE: Too many opened files.")):this.emit("error",e)};