/*
 * grunt-contrib-watch
 * http://gruntjs.com/
 *
 * Copyright (c) 2014 "Cowboy" Ben Alman, contributors
 * Licensed under the MIT license.
 */

var path=require("path"),EE=require("events").EventEmitter,util=require("util");module.exports=function(e){function n(e){this.name=e.name||0,this.files=e.files||[],this._getConfig=e._getConfig,this.options=e.options,this.startedAt=!1,this.spawned=null,this.changedFiles=Object.create(null),this.spawnTaskFailure=!1,this.livereloadOnError=!0,typeof this.options.livereloadOnError!="undefined"&&(this.livereloadOnError=this.options.livereloadOnError)}var t=require("./livereload")(e),r=function(){return typeof e.fail.forever_warncount!="undefined"?e.fail.forever_warncount+e.fail.forever_errorcount:e.fail.warncount+e.fail.errorcount};return n.prototype.run=function(t){var n=this;if(n.startedAt!==!1)return;n.startedAt=Date.now(),n.spawnTaskFailure=!1,n.errorsAndWarningsCount=r(),n.tasks=n._getConfig("tasks")||[],typeof n.tasks=="string"&&(n.tasks=[n.tasks]);if(n.tasks.length<1)return t();n.options.spawn===!1||n.options.nospawn===!0?(e.task.run(n.tasks),t()):n.spawned=e.util.spawn({grunt:!0,opts:{cwd:n.options.cwd.spawn,stdio:"inherit"},args:n.tasks.concat(n.options.cliArgs||[])},function(e,r,i){n.spawnTaskFailure=i!==0;if(n.options.interrupt!==!0||i!==130&&i!==1)n.spawned=null,t()})},n.prototype.complete=function(){var e=Date.now()-this.startedAt;this.startedAt=!1,this.spawned&&(this.spawned.kill("SIGINT"),this.spawned=null);var t=this.spawnTaskFailure||r()>this.errorsAndWarningsCount;return this.errorsAndWarningsCount=r(),this.livereload&&(this.livereloadOnError||!t)&&(this.livereload.trigger(Object.keys(this.changedFiles)),this.changedFiles=Object.create(null)),e},n};