/*
 * grunt-contrib-sass
 * http://gruntjs.com/
 *
 * Copyright (c) 2013 Sindre Sorhus, contributors
 * Licensed under the MIT license.
 */

var path=require("path"),dargs=require("dargs"),numCPUs=require("os").cpus().length,async=require("async"),chalk=require("chalk"),spawn=require("win-spawn"),which=require("which");module.exports=function(e){var t=function(t,n){var r;e.log.verbose.writeln("Writing CSS banner for "+t),r=e.file.read(t),e.file.write(t,n+e.util.linefeed+r)};e.registerMultiTask("sass","Compile Sass to CSS",function(){var n=this.async(),r=this.options(),i,s,o;try{which.sync("sass")}catch(u){return e.warn("\nYou need to have Ruby and Sass installed and in your PATH for this task to work.\nMore info: https://github.com/gruntjs/grunt-contrib-sass\n")}r.banner&&(o=r.banner,delete r.banner),i=dargs(r,["bundleExec"]),s=r.bundleExec,async.eachLimit(this.files,numCPUs,function(n,r){var u=n.src[0];typeof u!="string"&&(u=n.orig.src[0]);if(!e.file.exists(u))return e.log.warn('Source file "'+u+'" not found.'),r();if(path.basename(u)[0]==="_")return r();var a=[u,n.dest,"--load-path",path.dirname(u)].concat(i),f="sass";s&&(f="bundle",a.unshift("exec","sass")),path.extname(u)===".css"&&a.push("--scss"),e.file.exists(n.dest)||e.file.write(n.dest,"");var l=spawn(f,a,{stdio:"inherit"});l.on("error",function(t){e.warn(t)}),l.on("close",function(i){if(i>0)return e.warn("Exited with error code "+i);o&&t(n.dest,o),e.log.writeln("File "+chalk.cyan(n.dest)+" created."),r()})},n)})};