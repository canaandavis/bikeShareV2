// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

function BufferStream(){this.chunks=[],this.length=0,this.writable=!0,this.readable=!0}function SlowStream(e){this.trickle=e,this.offset=0,this.readable=this.writable=!0}var assert=require("assert"),zlib=require("../"),path=require("path"),zlibPairs=[[zlib.Deflate,zlib.Inflate],[zlib.Gzip,zlib.Gunzip],[zlib.Deflate,zlib.Unzip],[zlib.Gzip,zlib.Unzip],[zlib.DeflateRaw,zlib.InflateRaw]],trickle=[128,1024,1048576],chunkSize=[128,1024,16384,1048576],level=[-1,0,1,2,3,4,5,6,7,8,9],windowBits=[8,9,10,11,12,13,14,15],memLevel=[1,2,3,4,5,6,7,8,9],strategy=[0,1,2,3,4];process.env.PUMMEL||(trickle=[1024],chunkSize=[16384],level=[6],memLevel=[8],windowBits=[15],strategy=[0]);var fs=require("fs");process.env.FAST&&(zlibPairs=[[zlib.Gzip,zlib.Unzip]]);var tests={"person.jpg":fs.readFileSync(__dirname+"/fixtures/person.jpg"),"elipses.txt":fs.readFileSync(__dirname+"/fixtures/elipses.txt"),"empty.txt":fs.readFileSync(__dirname+"/fixtures/empty.txt")},util=require("util"),stream=require("stream");util.inherits(BufferStream,stream.Stream),BufferStream.prototype.write=function(e){return this.chunks.push(e),this.length+=e.length,!0},BufferStream.prototype.end=function(e){e&&this.write(e);var t=new Buffer(this.length),n=0;return this.chunks.forEach(function(e){e.copy(t,n),n+=e.length}),this.emit("data",t),this.emit("end"),!0},util.inherits(SlowStream,stream.Stream),SlowStream.prototype.write=function(){throw new Error("not implemented, just call ss.end(chunk)")},SlowStream.prototype.pause=function(){this.paused=!0,this.emit("pause")},SlowStream.prototype.resume=function(){function t(){if(e.paused)return;if(e.offset>=e.length)return e.ended=!0,e.emit("end");var n=Math.min(e.offset+e.trickle,e.length),r=e.chunk.slice(e.offset,n);e.offset+=r.length,e.emit("data",r),process.nextTick(t)}var e=this;if(e.ended)return;e.emit("resume");if(!e.chunk)return;e.paused=!1,t()},SlowStream.prototype.end=function(e){var t=this;return t.chunk=e,t.length=e.length,t.resume(),t.ended};var tape=require("tape");Object.keys(tests).forEach(function(e){var t=tests[e];chunkSize.forEach(function(n){trickle.forEach(function(r){windowBits.forEach(function(i){level.forEach(function(s){memLevel.forEach(function(o){strategy.forEach(function(u){zlibPairs.forEach(function(a){var f=a[0],l=a[1],c={level:s,windowBits:i,memLevel:o,strategy:u},h=e+" "+n+" "+JSON.stringify(c)+" "+f.name+" -> "+l.name;tape("zlib "+h,function(e){e.plan(1);var n=new f(c),i=new l(c),s=new SlowStream(r),o=new BufferStream;o.on("data",function(n){e.deepEqual(n,t)}),s.pipe(n).pipe(i).pipe(o),s.end(t)})})})})})})})})});