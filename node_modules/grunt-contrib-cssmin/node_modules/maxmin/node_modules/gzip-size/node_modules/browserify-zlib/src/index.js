// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

function zlibBuffer(e,t,n){function s(){var t;while(null!==(t=e.read()))r.push(t),i+=t.length;e.once("readable",s)}function o(t){e.removeListener("end",u),e.removeListener("readable",s),n(t)}function u(){var t=Buffer.concat(r,i);r=[],n(null,t),e.close()}var r=[],i=0;e.on("error",o),e.on("end",u),e.end(t),s()}function zlibBufferSync(e,t){typeof t=="string"&&(t=new Buffer(t));if(!Buffer.isBuffer(t))throw new TypeError("Not a string or buffer");var n=binding.Z_FINISH;return e._processChunk(t,n)}function Deflate(e){if(!(this instanceof Deflate))return new Deflate(e);Zlib.call(this,e,binding.DEFLATE)}function Inflate(e){if(!(this instanceof Inflate))return new Inflate(e);Zlib.call(this,e,binding.INFLATE)}function Gzip(e){if(!(this instanceof Gzip))return new Gzip(e);Zlib.call(this,e,binding.GZIP)}function Gunzip(e){if(!(this instanceof Gunzip))return new Gunzip(e);Zlib.call(this,e,binding.GUNZIP)}function DeflateRaw(e){if(!(this instanceof DeflateRaw))return new DeflateRaw(e);Zlib.call(this,e,binding.DEFLATERAW)}function InflateRaw(e){if(!(this instanceof InflateRaw))return new InflateRaw(e);Zlib.call(this,e,binding.INFLATERAW)}function Unzip(e){if(!(this instanceof Unzip))return new Unzip(e);Zlib.call(this,e,binding.UNZIP)}function Zlib(e,t){this._opts=e=e||{},this._chunkSize=e.chunkSize||exports.Z_DEFAULT_CHUNK,Transform.call(this,e);if(e.flush&&e.flush!==binding.Z_NO_FLUSH&&e.flush!==binding.Z_PARTIAL_FLUSH&&e.flush!==binding.Z_SYNC_FLUSH&&e.flush!==binding.Z_FULL_FLUSH&&e.flush!==binding.Z_FINISH&&e.flush!==binding.Z_BLOCK)throw new Error("Invalid flush flag: "+e.flush);this._flushFlag=e.flush||binding.Z_NO_FLUSH;if(e.chunkSize)if(e.chunkSize<exports.Z_MIN_CHUNK||e.chunkSize>exports.Z_MAX_CHUNK)throw new Error("Invalid chunk size: "+e.chunkSize);if(e.windowBits)if(e.windowBits<exports.Z_MIN_WINDOWBITS||e.windowBits>exports.Z_MAX_WINDOWBITS)throw new Error("Invalid windowBits: "+e.windowBits);if(e.level)if(e.level<exports.Z_MIN_LEVEL||e.level>exports.Z_MAX_LEVEL)throw new Error("Invalid compression level: "+e.level);if(e.memLevel)if(e.memLevel<exports.Z_MIN_MEMLEVEL||e.memLevel>exports.Z_MAX_MEMLEVEL)throw new Error("Invalid memLevel: "+e.memLevel);if(e.strategy&&e.strategy!=exports.Z_FILTERED&&e.strategy!=exports.Z_HUFFMAN_ONLY&&e.strategy!=exports.Z_RLE&&e.strategy!=exports.Z_FIXED&&e.strategy!=exports.Z_DEFAULT_STRATEGY)throw new Error("Invalid strategy: "+e.strategy);if(e.dictionary&&!Buffer.isBuffer(e.dictionary))throw new Error("Invalid dictionary: it should be a Buffer instance");this._binding=new binding.Zlib(t);var n=this;this._hadError=!1,this._binding.onerror=function(e,t){n._binding=null,n._hadError=!0;var r=new Error(e);r.errno=t,r.code=exports.codes[t],n.emit("error",r)};var r=exports.Z_DEFAULT_COMPRESSION;typeof e.level=="number"&&(r=e.level);var i=exports.Z_DEFAULT_STRATEGY;typeof e.strategy=="number"&&(i=e.strategy),this._binding.init(e.windowBits||exports.Z_DEFAULT_WINDOWBITS,r,e.memLevel||exports.Z_DEFAULT_MEMLEVEL,i,e.dictionary),this._buffer=new Buffer(this._chunkSize),this._offset=0,this._closed=!1,this._level=r,this._strategy=i,this.once("end",this.close)}var Transform=require("_stream_transform"),binding=require("./binding"),util=require("util"),assert=require("assert").ok;binding.Z_MIN_WINDOWBITS=8,binding.Z_MAX_WINDOWBITS=15,binding.Z_DEFAULT_WINDOWBITS=15,binding.Z_MIN_CHUNK=64,binding.Z_MAX_CHUNK=Infinity,binding.Z_DEFAULT_CHUNK=16384,binding.Z_MIN_MEMLEVEL=1,binding.Z_MAX_MEMLEVEL=9,binding.Z_DEFAULT_MEMLEVEL=8,binding.Z_MIN_LEVEL=-1,binding.Z_MAX_LEVEL=9,binding.Z_DEFAULT_LEVEL=binding.Z_DEFAULT_COMPRESSION,Object.keys(binding).forEach(function(e){e.match(/^Z/)&&(exports[e]=binding[e])}),exports.codes={Z_OK:binding.Z_OK,Z_STREAM_END:binding.Z_STREAM_END,Z_NEED_DICT:binding.Z_NEED_DICT,Z_ERRNO:binding.Z_ERRNO,Z_STREAM_ERROR:binding.Z_STREAM_ERROR,Z_DATA_ERROR:binding.Z_DATA_ERROR,Z_MEM_ERROR:binding.Z_MEM_ERROR,Z_BUF_ERROR:binding.Z_BUF_ERROR,Z_VERSION_ERROR:binding.Z_VERSION_ERROR},Object.keys(exports.codes).forEach(function(e){exports.codes[exports.codes[e]]=e}),exports.Deflate=Deflate,exports.Inflate=Inflate,exports.Gzip=Gzip,exports.Gunzip=Gunzip,exports.DeflateRaw=DeflateRaw,exports.InflateRaw=InflateRaw,exports.Unzip=Unzip,exports.createDeflate=function(e){return new Deflate(e)},exports.createInflate=function(e){return new Inflate(e)},exports.createDeflateRaw=function(e){return new DeflateRaw(e)},exports.createInflateRaw=function(e){return new InflateRaw(e)},exports.createGzip=function(e){return new Gzip(e)},exports.createGunzip=function(e){return new Gunzip(e)},exports.createUnzip=function(e){return new Unzip(e)},exports.deflate=function(e,t,n){return typeof t=="function"&&(n=t,t={}),zlibBuffer(new Deflate(t),e,n)},exports.deflateSync=function(e,t){return zlibBufferSync(new Deflate(t),e)},exports.gzip=function(e,t,n){return typeof t=="function"&&(n=t,t={}),zlibBuffer(new Gzip(t),e,n)},exports.gzipSync=function(e,t){return zlibBufferSync(new Gzip(t),e)},exports.deflateRaw=function(e,t,n){return typeof t=="function"&&(n=t,t={}),zlibBuffer(new DeflateRaw(t),e,n)},exports.deflateRawSync=function(e,t){return zlibBufferSync(new DeflateRaw(t),e)},exports.unzip=function(e,t,n){return typeof t=="function"&&(n=t,t={}),zlibBuffer(new Unzip(t),e,n)},exports.unzipSync=function(e,t){return zlibBufferSync(new Unzip(t),e)},exports.inflate=function(e,t,n){return typeof t=="function"&&(n=t,t={}),zlibBuffer(new Inflate(t),e,n)},exports.inflateSync=function(e,t){return zlibBufferSync(new Inflate(t),e)},exports.gunzip=function(e,t,n){return typeof t=="function"&&(n=t,t={}),zlibBuffer(new Gunzip(t),e,n)},exports.gunzipSync=function(e,t){return zlibBufferSync(new Gunzip(t),e)},exports.inflateRaw=function(e,t,n){return typeof t=="function"&&(n=t,t={}),zlibBuffer(new InflateRaw(t),e,n)},exports.inflateRawSync=function(e,t){return zlibBufferSync(new InflateRaw(t),e)},util.inherits(Zlib,Transform),Zlib.prototype.params=function(e,t,n){if(e<exports.Z_MIN_LEVEL||e>exports.Z_MAX_LEVEL)throw new RangeError("Invalid compression level: "+e);if(t!=exports.Z_FILTERED&&t!=exports.Z_HUFFMAN_ONLY&&t!=exports.Z_RLE&&t!=exports.Z_FIXED&&t!=exports.Z_DEFAULT_STRATEGY)throw new TypeError("Invalid strategy: "+t);if(this._level!==e||this._strategy!==t){var r=this;this.flush(binding.Z_SYNC_FLUSH,function(){r._binding.params(e,t),r._hadError||(r._level=e,r._strategy=t,n&&n())})}else process.nextTick(n)},Zlib.prototype.reset=function(){return this._binding.reset()},Zlib.prototype._flush=function(e){this._transform(new Buffer(0),"",e)},Zlib.prototype.flush=function(e,t){var n=this._writableState;if(typeof e=="function"||e===void 0&&!t)t=e,e=binding.Z_FULL_FLUSH;if(n.ended)t&&process.nextTick(t);else if(n.ending)t&&this.once("end",t);else if(n.needDrain){var r=this;this.once("drain",function(){r.flush(t)})}else this._flushFlag=e,this.write(new Buffer(0),"",t)},Zlib.prototype.close=function(e){e&&process.nextTick(e);if(this._closed)return;this._closed=!0,this._binding.close();var t=this;process.nextTick(function(){t.emit("close")})},Zlib.prototype._transform=function(e,t,n){var r,i=this._writableState,s=i.ending||i.ended,o=s&&(!e||i.length===e.length);if(!e===null&&!Buffer.isBuffer(e))return n(new Error("invalid input"));o?r=binding.Z_FINISH:(r=this._flushFlag,e.length>=i.length&&(this._flushFlag=this._opts.flush||binding.Z_NO_FLUSH));var u=this;this._processChunk(e,r,n)},Zlib.prototype._processChunk=function(e,t,n){function d(l,c){if(o._hadError)return;var h=i-c;assert(h>=0,"have should not go down");if(h>0){var p=o._buffer.slice(o._offset,o._offset+h);o._offset+=h,u?o.push(p):(a.push(p),f+=p.length)}if(c===0||o._offset>=o._chunkSize)i=o._chunkSize,o._offset=0,o._buffer=new Buffer(o._chunkSize);if(c===0){s+=r-l,r=l;if(!u)return!0;var v=o._binding.write(t,e,s,r,o._buffer,o._offset,o._chunkSize);v.callback=d,v.buffer=e;return}if(!u)return!1;n()}var r=e&&e.length,i=this._chunkSize-this._offset,s=0,o=this,u=typeof n=="function";if(!u){var a=[],f=0,l;this.on("error",function(e){l=e});do var c=this._binding.writeSync(t,e,s,r,this._buffer,this._offset,i);while(!this._hadError&&d(c[0],c[1]));if(this._hadError)throw l;var h=Buffer.concat(a,f);return this.close(),h}var p=this._binding.write(t,e,s,r,this._buffer,this._offset,i);p.buffer=e,p.callback=d},util.inherits(Deflate,Zlib),util.inherits(Inflate,Zlib),util.inherits(Gzip,Zlib),util.inherits(Gunzip,Zlib),util.inherits(DeflateRaw,Zlib),util.inherits(InflateRaw,Zlib),util.inherits(Unzip,Zlib);