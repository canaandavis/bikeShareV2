/*
 * $Id: rawdeflate.js,v 0.5 2013/04/09 14:25:38 dankogai Exp dankogai $
 *
 * GNU General Public License, version 2 (GPL-2.0)
 *   http://opensource.org/licenses/GPL-2.0
 * Original:
 *  http://www.onicos.com/staff/iz/amuse/javascript/expert/deflate.txt
 */

/* Copyright (C) 1999 Masanao Izumo <iz@onicos.co.jp>
 * Version: 1.0.1
 * LastModified: Dec 25 1999
 */

(function(e){var t=32768,n=0,r=1,i=2,s=6,o=!0,u=32768,a=64,f=8192,l=2*t,c=3,h=258,p=16,d=8192,v=13;d>u&&alert("error: zip_INBUFSIZ is too small"),t<<1>1<<p&&alert("error: zip_WSIZE is too large"),v>p-1&&alert("error: zip_HASH_BITS is too large"),(v<8||h!=258)&&alert("error: Code too clever");var m=d,g=1<<v,y=g-1,b=t-1,w=0,E=4096,S=h+c+1,x=t-S,T=1,N=15,C=7,k=29,L=256,A=256,O=L+1+k,M=30,_=19,D=16,P=17,H=18,B=2*O+1,j=parseInt((v+c-1)/c),F,I,q,R,U=null,z,W,X,V,$,J,K,Q,G,Y,Z,et,tt,nt,rt,it,st,ot,ut,at,ft,lt,ct,ht,pt,dt,vt,mt,gt,yt,bt,wt,Et,St,xt,Tt,Nt,Ct,kt,Lt,At,Ot,Mt,_t,Dt,Pt,Ht,Bt,jt,Ft,It,qt,Rt=function(){this.fc=0,this.dl=0},Ut=function(){this.dyn_tree=null,this.static_tree=null,this.extra_bits=null,this.extra_base=0,this.elems=0,this.max_length=0,this.max_code=0},zt=function(e,t,n,r){this.good_length=e,this.max_lazy=t,this.nice_length=n,this.max_chain=r},Wt=function(){this.next=null,this.len=0,this.ptr=new Array(f),this.off=0},Xt=new Array(0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0),Vt=new Array(0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13),$t=new Array(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7),Jt=new Array(16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15),Kt=new Array(new zt(0,0,0,0),new zt(4,4,8,4),new zt(4,5,16,8),new zt(4,6,32,32),new zt(4,4,16,16),new zt(8,16,32,32),new zt(8,16,128,128),new zt(8,32,128,256),new zt(32,128,258,1024),new zt(32,258,258,4096)),Qt=function(e){var t;e?e<1?e=1:e>9&&(e=9):e=s,ct=e,R=!1,ut=!1;if(U!=null)return;F=I=q=null,U=new Array(f),V=new Array(l),$=new Array(m),J=new Array(u+a),K=new Array(1<<p),dt=new Array(B);for(t=0;t<B;t++)dt[t]=new Rt;vt=new Array(2*M+1);for(t=0;t<2*M+1;t++)vt[t]=new Rt;mt=new Array(O+2);for(t=0;t<O+2;t++)mt[t]=new Rt;gt=new Array(M);for(t=0;t<M;t++)gt[t]=new Rt;yt=new Array(2*_+1);for(t=0;t<2*_+1;t++)yt[t]=new Rt;bt=new Ut,wt=new Ut,Et=new Ut,St=new Array(N+1),xt=new Array(2*O+1),Ct=new Array(2*O+1),kt=new Array(h-c+1),Lt=new Array(512),At=new Array(k),Ot=new Array(M),Mt=new Array(parseInt(d/8))},Gt=function(){F=I=q=null,U=null,V=null,$=null,J=null,K=null,dt=null,vt=null,mt=null,gt=null,yt=null,bt=null,wt=null,Et=null,St=null,xt=null,Ct=null,kt=null,Lt=null,At=null,Ot=null,Mt=null},Yt=function(e){e.next=F,F=e},Zt=function(){var e;return F!=null?(e=F,F=F.next):e=new Wt,e.next=null,e.len=e.off=0,e},en=function(e){return K[t+e]},tn=function(e,n){return K[t+e]=n},nn=function(e){U[W+z++]=e,W+z==f&&Hn()},rn=function(e){e&=65535,W+z<f-2?(U[W+z++]=e&255,U[W+z++]=e>>>8):(nn(e&255),nn(e>>>8))},sn=function(){Z=(Z<<j^V[st+c-1]&255)&y,et=en(Z),K[st&b]=et,tn(Z,st)},on=function(e,t){_n(t[e].fc,t[e].dl)},un=function(e){return(e<256?Lt[e]:Lt[256+(e>>7)])&255},an=function(e,t,n){return e[t].fc<e[n].fc||e[t].fc==e[n].fc&&Ct[t]<=Ct[n]},fn=function(e,t,n){var r;for(r=0;r<n&&qt<It.length;r++)e[t+r]=It[qt++];return r},ln=function(){var e;for(e=0;e<g;e++)K[t+e]=0;lt=Kt[ct].max_lazy,ht=Kt[ct].good_length,o||(pt=Kt[ct].nice_length),ft=Kt[ct].max_chain,st=0,Y=0,at=fn(V,0,2*t);if(at<=0){ut=!0,at=0;return}ut=!1;while(at<S&&!ut)hn();Z=0;for(e=0;e<c-1;e++)Z=(Z<<j^V[e]&255)&y},cn=function(e){var t=ft,n=st,r,i,s=it,u=st>x?st-x:w,a=st+h,f=V[n+s-1],l=V[n+s];it>=ht&&(t>>=2);do{r=e;if(V[r+s]!=l||V[r+s-1]!=f||V[r]!=V[n]||V[++r]!=V[n+1])continue;n+=2,r++;do;while(V[++n]==V[++r]&&V[++n]==V[++r]&&V[++n]==V[++r]&&V[++n]==V[++r]&&V[++n]==V[++r]&&V[++n]==V[++r]&&V[++n]==V[++r]&&V[++n]==V[++r]&&n<a);i=h-(a-n),n=a-h;if(i>s){ot=e,s=i;if(o){if(i>=h)break}else if(i>=pt)break;f=V[n+s-1],l=V[n+s]}}while((e=K[e&b])>u&&--t!=0);return s},hn=function(){var e,n,r=l-at-st;if(r==-1)r--;else if(st>=t+x){for(e=0;e<t;e++)V[e]=V[e+t];ot-=t,st-=t,Y-=t;for(e=0;e<g;e++)n=en(e),tn(e,n>=t?n-t:w);for(e=0;e<t;e++)n=K[e],K[e]=n>=t?n-t:w;r+=t}ut||(e=fn(V,st+at,r),e<=0?ut=!0:at+=e)},pn=function(){while(at!=0&&I==null){var e;sn(),et!=w&&st-et<=x&&(rt=cn(et),rt>at&&(rt=at));if(rt>=c){e=An(st-ot,rt-c),at-=rt;if(rt<=lt){rt--;do st++,sn();while(--rt!=0);st++}else st+=rt,rt=0,Z=V[st]&255,Z=(Z<<j^V[st+1]&255)&y}else e=An(0,V[st]&255),at--,st++;e&&(Ln(0),Y=st);while(at<S&&!ut)hn()}},dn=function(){while(at!=0&&I==null){sn(),it=rt,tt=ot,rt=c-1,et!=w&&it<lt&&st-et<=x&&(rt=cn(et),rt>at&&(rt=at),rt==c&&st-ot>E&&rt--);if(it>=c&&rt<=it){var e;e=An(st-1-tt,it-c),at-=it-1,it-=2;do st++,sn();while(--it!=0);nt=0,rt=c-1,st++,e&&(Ln(0),Y=st)}else nt!=0?(An(0,V[st-1]&255)&&(Ln(0),Y=st),st++,at--):(nt=1,st++,at--);while(at<S&&!ut)hn()}},vn=function(){if(ut)return;Q=0,G=0,yn(),ln(),I=null,z=0,W=0,nt=0,ct<=3?(it=c-1,rt=0):(rt=c-1,nt=0,nt=0),X=!1},mn=function(e,t,n){var r;if(!R){vn(),R=!0;if(at==0)return X=!0,0}return(r=gn(e,t,n))==n?n:X?r:(ct<=3?pn():dn(),at==0&&(nt!=0&&An(0,V[st-1]&255),Ln(1),X=!0),r+gn(e,r+t,n-r))},gn=function(e,t,n){var r,i,s;r=0;while(I!=null&&r<n){i=n-r,i>I.len&&(i=I.len);for(s=0;s<i;s++)e[t+r+s]=I.ptr[I.off+s];I.off+=i,I.len-=i,r+=i;if(I.len==0){var o;o=I,I=I.next,Yt(o)}}if(r==n)return r;if(W<z){i=n-r,i>z-W&&(i=z-W);for(s=0;s<i;s++)e[t+r+s]=U[W+s];W+=i,r+=i,z==W&&(z=W=0)}return r},yn=function(){var e,t,n,r,i;if(gt[0].dl!=0)return;bt.dyn_tree=dt,bt.static_tree=mt,bt.extra_bits=Xt,bt.extra_base=L+1,bt.elems=O,bt.max_length=N,bt.max_code=0,wt.dyn_tree=vt,wt.static_tree=gt,wt.extra_bits=Vt,wt.extra_base=0,wt.elems=M,wt.max_length=N,wt.max_code=0,Et.dyn_tree=yt,Et.static_tree=null,Et.extra_bits=$t,Et.extra_base=0,Et.elems=_,Et.max_length=C,Et.max_code=0,n=0;for(r=0;r<k-1;r++){At[r]=n;for(e=0;e<1<<Xt[r];e++)kt[n++]=r}kt[n-1]=r,i=0;for(r=0;r<16;r++){Ot[r]=i;for(e=0;e<1<<Vt[r];e++)Lt[i++]=r}i>>=7;for(;r<M;r++){Ot[r]=i<<7;for(e=0;e<1<<Vt[r]-7;e++)Lt[256+i++]=r}for(t=0;t<=N;t++)St[t]=0;e=0;while(e<=143)mt[e++].dl=8,St[8]++;while(e<=255)mt[e++].dl=9,St[9]++;while(e<=279)mt[e++].dl=7,St[7]++;while(e<=287)mt[e++].dl=8,St[8]++;Sn(mt,O+1);for(e=0;e<M;e++)gt[e].dl=5,gt[e].fc=Dn(e,5);bn()},bn=function(){var e;for(e=0;e<O;e++)dt[e].fc=0;for(e=0;e<M;e++)vt[e].fc=0;for(e=0;e<_;e++)yt[e].fc=0;dt[A].fc=1,jt=Ft=0,_t=Dt=Pt=0,Ht=0,Bt=1},wn=function(e,t){var n=xt[t],r=t<<1;while(r<=Tt){r<Tt&&an(e,xt[r+1],xt[r])&&r++;if(an(e,n,xt[r]))break;xt[t]=xt[r],t=r,r<<=1}xt[t]=n},En=function(e){var t=e.dyn_tree,n=e.extra_bits,r=e.extra_base,i=e.max_code,s=e.max_length,o=e.static_tree,u,a,f,l,c,h,p=0;for(l=0;l<=N;l++)St[l]=0;t[xt[Nt]].dl=0;for(u=Nt+1;u<B;u++){a=xt[u],l=t[t[a].dl].dl+1,l>s&&(l=s,p++),t[a].dl=l;if(a>i)continue;St[l]++,c=0,a>=r&&(c=n[a-r]),h=t[a].fc,jt+=h*(l+c),o!=null&&(Ft+=h*(o[a].dl+c))}if(p==0)return;do{l=s-1;while(St[l]==0)l--;St[l]--,St[l+1]+=2,St[s]--,p-=2}while(p>0);for(l=s;l!=0;l--){a=St[l];while(a!=0){f=xt[--u];if(f>i)continue;t[f].dl!=l&&(jt+=(l-t[f].dl)*t[f].fc,t[f].fc=l),a--}}},Sn=function(e,t){var n=new Array(N+1),r=0,i,s;for(i=1;i<=N;i++)r=r+St[i-1]<<1,n[i]=r;for(s=0;s<=t;s++){var o=e[s].dl;if(o==0)continue;e[s].fc=Dn(n[o]++,o)}},xn=function(e){var t=e.dyn_tree,n=e.static_tree,r=e.elems,i,s,o=-1,u=r;Tt=0,Nt=B;for(i=0;i<r;i++)t[i].fc!=0?(xt[++Tt]=o=i,Ct[i]=0):t[i].dl=0;while(Tt<2){var a=xt[++Tt]=o<2?++o:0;t[a].fc=1,Ct[a]=0,jt--,n!=null&&(Ft-=n[a].dl)}e.max_code=o;for(i=Tt>>1;i>=1;i--)wn(t,i);do i=xt[T],xt[T]=xt[Tt--],wn(t,T),s=xt[T],xt[--Nt]=i,xt[--Nt]=s,t[u].fc=t[i].fc+t[s].fc,Ct[i]>Ct[s]+1?Ct[u]=Ct[i]:Ct[u]=Ct[s]+1,t[i].dl=t[s].dl=u,xt[T]=u++,wn(t,T);while(Tt>=2);xt[--Nt]=xt[T],En(e),Sn(t,o)},Tn=function(e,t){var n,r=-1,i,s=e[0].dl,o=0,u=7,a=4;s==0&&(u=138,a=3),e[t+1].dl=65535;for(n=0;n<=t;n++){i=s,s=e[n+1].dl;if(++o<u&&i==s)continue;o<a?yt[i].fc+=o:i!=0?(i!=r&&yt[i].fc++,yt[D].fc++):o<=10?yt[P].fc++:yt[H].fc++,o=0,r=i,s==0?(u=138,a=3):i==s?(u=6,a=3):(u=7,a=4)}},Nn=function(e,t){var n,r=-1,i,s=e[0].dl,o=0,u=7,a=4;s==0&&(u=138,a=3);for(n=0;n<=t;n++){i=s,s=e[n+1].dl;if(++o<u&&i==s)continue;if(o<a){do on(i,yt);while(--o!=0)}else i!=0?(i!=r&&(on(i,yt),o--),on(D,yt),_n(o-3,2)):o<=10?(on(P,yt),_n(o-3,3)):(on(H,yt),_n(o-11,7));o=0,r=i,s==0?(u=138,a=3):i==s?(u=6,a=3):(u=7,a=4)}},Cn=function(){var e;Tn(dt,bt.max_code),Tn(vt,wt.max_code),xn(Et);for(e=_-1;e>=3;e--)if(yt[Jt[e]].dl!=0)break;return jt+=3*(e+1)+5+5+4,e},kn=function(e,t,n){var r;_n(e-257,5),_n(t-1,5),_n(n-4,4);for(r=0;r<n;r++)_n(yt[Jt[r]].dl,3);Nn(dt,e-1),Nn(vt,t-1)},Ln=function(e){var t,s,o,u;u=st-Y,Mt[Pt]=Ht,xn(bt),xn(wt),o=Cn(),t=jt+3+7>>3,s=Ft+3+7>>3,s<=t&&(t=s);if(u+4<=t&&Y>=0){var a;_n((n<<1)+e,3),Pn(),rn(u),rn(~u);for(a=0;a<u;a++)nn(V[Y+a])}else s==t?(_n((r<<1)+e,3),On(mt,gt)):(_n((i<<1)+e,3),kn(bt.max_code+1,wt.max_code+1,o+1),On(dt,vt));bn(),e!=0&&Pn()},An=function(e,t){J[_t++]=t,e==0?dt[t].fc++:(e--,dt[kt[t]+L+1].fc++,vt[un(e)].fc++,$[Dt++]=e,Ht|=Bt),Bt<<=1,(_t&7)==0&&(Mt[Pt++]=Ht,Ht=0,Bt=1);if(ct>2&&(_t&4095)==0){var n=_t*8,r=st-Y,i;for(i=0;i<M;i++)n+=vt[i].fc*(5+Vt[i]);n>>=3;if(Dt<parseInt(_t/2)&&n<parseInt(r/2))return!0}return _t==d-1||Dt==m},On=function(e,t){var n,r,i=0,s=0,o=0,u=0,a,f;if(_t!=0)do(i&7)==0&&(u=Mt[o++]),r=J[i++]&255,(u&1)==0?on(r,e):(a=kt[r],on(a+L+1,e),f=Xt[a],f!=0&&(r-=At[a],_n(r,f)),n=$[s++],a=un(n),on(a,t),f=Vt[a],f!=0&&(n-=Ot[a],_n(n,f))),u>>=1;while(i<_t);on(A,e)},Mn=16,_n=function(e,t){G>Mn-t?(Q|=e<<G,rn(Q),Q=e>>Mn-G,G+=t-Mn):(Q|=e<<G,G+=t)},Dn=function(e,t){var n=0;do n|=e&1,e>>=1,n<<=1;while(--t>0);return n>>1},Pn=function(){G>8?rn(Q):G>0&&nn(Q),Q=0,G=0},Hn=function(){if(z!=0){var e,t;e=Zt(),I==null?I=q=e:q=q.next=e,e.len=z-W;for(t=0;t<e.len;t++)e.ptr[t]=U[W+t];z=W=0}},Bn=function(e,t){var n,r;It=e,qt=0,typeof t=="undefined"&&(t=s),Qt(t);var i=new Array(16384),o=[];while((n=mn(i,0,i.length))>0){var u=new Array(n);for(r=0;r<n;r++)u[r]=String.fromCharCode(i[r]);o[o.length]=u.join("")}return It=null,o.join("")};e.RawDeflate||(e.RawDeflate={}),e.RawDeflate.deflate=Bn})(this);