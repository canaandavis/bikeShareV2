/**
 * Clean-css - https://github.com/GoalSmashers/clean-css
 * Released under the terms of MIT license
 *
 * Copyright (C) 2011-2014 GoalSmashers.com
 */

var ColorShortener=require("./colors/shortener"),ColorHSLToHex=require("./colors/hsl-to-hex"),ColorRGBToHex=require("./colors/rgb-to-hex"),ColorLongToShortHex=require("./colors/long-to-short-hex"),ImportInliner=require("./imports/inliner"),UrlRebase=require("./images/url-rebase"),EmptyRemoval=require("./selectors/empty-removal"),CommentsProcessor=require("./text/comments"),ExpressionsProcessor=require("./text/expressions"),FreeTextProcessor=require("./text/free"),UrlsProcessor=require("./text/urls"),NameQuotesProcessor=require("./text/name-quotes"),Splitter=require("./text/splitter"),SelectorsOptimizer=require("./selectors/optimizer"),CleanCSS=module.exports=function e(t){t=t||{};if(!(this instanceof e))return new e(t);t.keepBreaks=t.keepBreaks||!1,undefined===t.processImport&&(t.processImport=!0),this.options=t,this.stats={},this.context={errors:[],warnings:[],debug:t.debug},this.errors=this.context.errors,this.warnings=this.context.warnings,this.lineBreak=process.platform=="win32"?"\r\n":"\n"};CleanCSS.prototype.minify=function(e,t){var n=this.options;Buffer.isBuffer(e)&&(e=e.toString());if(n.processImport||e.indexOf("@shallow")>0){var r=this,i=t?process.nextTick:function(e){return e()};return i(function(){return(new ImportInliner(r.context,n.inliner)).process(e,{localOnly:!t,root:n.root||process.cwd(),relativeTo:n.relativeTo,whenDone:function(e){return minify.call(r,e,t)}})})}return minify.call(this,e,t)};var minify=function(e,t){var n,r=this.stats,i=this.options,s=this.context,o=this.lineBreak,u=new CommentsProcessor("keepSpecialComments"in i?i.keepSpecialComments:"*",i.keepBreaks,o),a=new ExpressionsProcessor,f=new FreeTextProcessor,l=new UrlsProcessor,c=new NameQuotesProcessor;i.debug&&(this.startedAt=process.hrtime(),this.stats.originalSize=e.length);var h=function(){typeof arguments[0]=="function"?arguments[0]():e=e.replace.apply(e,arguments)};if(i.benchmark){var p=h;h=function(e,t){var n=typeof e=="function"?/function (\w+)\(/.exec(e.toString())[1]:e,r=process.hrtime();p(e,t);var i=process.hrtime(r);console.log("%d ms: "+n,1e3*i[0]+i[1]/1e6)}}i.debug&&(n=process.hrtime(),r.originalSize=e.length),h(function(){e=u.escape(e)}),h(/\\(\r\n|\n)/gm,""),h(/url\((['"])([^\)]+)['"]\)/g,function(e,t,n){var r=n.indexOf("data:")===0&&n.match(/data:\w+\/[^;]+;base64,/)===null;return n.match(/[ \t]/g)!==null||r?"url("+t+n+t+")":"url("+n+")"}),h(function(){e=c.process(e)}),h(/@(\-moz\-|\-o\-|\-webkit\-)?keyframes ([^{]+)/g,function(e,t,n){return t=t||"","@"+t+"keyframes "+(n.indexOf(" ")>-1?n:n.replace(/['"]/g,""))}),h(/progid:DXImageTransform\.Microsoft\.(Alpha|Chroma)(\([^\)]+\))([;}'"])/g,function(e,t,n,r){return t.toLowerCase()+n+r}),h(function(){e=a.escape(e)}),h(/\[([^\]]+)\]/g,function(e,t){var n=t.indexOf("="),r=t.indexOf("'"),i=t.indexOf('"');if(n<0&&r<0&&i<0)return e;if(r===0||i===0)return e;var s=t.substring(0,n),o=t.substring(n+1,t.length);return/^['"](?:[a-zA-Z][a-zA-Z\d\-_]+)['"]$/.test(o)?"["+s+"="+o.substring(1,o.length-1)+"]":e}),h(function(){e=f.escape(e)}),h(function(){e=l.escape(e)}),h(/@charset [^;]+;/ig,function(e){return e.indexOf("@charset")>-1?e:""}),h(/\[([^\]]+)\]/g,function(e){return e.replace(/\s/g,"")}),h(/[\r]?\n/g," "),h(/[\t ]+/g," "),h(/;[ ]?;+/g,";"),h(/ (?:\r\n|\n)/g,o),h(/(?:\r\n|\n)+/g,o),h(/ ([+~>]) /g,"$1"),h(/([!\(\{\}:;=,\n]) /g,"$1"),h(/ ([!\)\{\};=,\n])/g,"$1"),h(/(?:\r\n|\n)\}/g,"}"),h(/([\{;,])(?:\r\n|\n)/g,"$1"),h(/ :([^\{\};]+)([;}])/g,":$1$2"),h(/progid:[^(]+\(([^\)]+)/g,function(e){return e.replace(/,/g,", ")}),h(/;\}/g,"}"),h(function(){e=(new ColorHSLToHex(e)).process()}),h(function(){e=(new ColorRGBToHex(e)).process()}),h(function(){e=(new ColorLongToShortHex(e)).process()}),h(function(){e=(new ColorShortener(e)).process()}),h(/(font\-weight|font):(normal|bold)([ ;\}!])(\w*)/g,function(e,t,n,r,i){return r==" "&&(i.indexOf("/")>-1||i=="normal"||/[1-9]00/.test(i))?e:n=="normal"?t+":400"+r+i:n=="bold"?t+":700"+r+i:e});var d=/(\s|:|,|\()\-0([^\.])/g;h(d,"$10$2"),h(d,"$10$2"),h(/(\s|:|,)0+([1-9])/g,"$1$2");var v="roundingPrecision"in i?i.roundingPrecision:2,m=Math.pow(10,v);h(new RegExp("\\.(\\d{"+(v+1)+",})px","g"),function(e,t){return v===0?"px":"."+Math.round(parseFloat("."+t)*m)/m+"px"});var g=/(\D)\.0+(\D)/g;h(g,"$10$2"),h(g,"$10$2"),h(/\.([1-9]*)0+(\D)/g,function(e,t,n){return(t.length>0?".":"")+t+n});var y=["px","em","ex","cm","mm","in","pt","pc","%"];["ie7","ie8"].indexOf(i.compatibility)==-1&&y.push("rem"),h(new RegExp("(\\s|:|,)\\-?0(?:"+y.join("|")+")","g"),"$10"),h(new RegExp("(\\s|:|,)\\-?(\\d+)\\.(\\D)","g"),"$1$2$3"),h(new RegExp("rect\\(0(?:"+y.join("|")+")","g"),"rect(0"),h(/(rgb|rgba|hsl|hsla)\(([^\)]+)\)/g,function(e,t,n){var r=n.split(","),i=t=="hsl"||t=="hsla"||r[0].indexOf("%")>-1;return i?(r[1].indexOf("%")==-1&&(r[1]+="%"),r[2].indexOf("%")==-1&&(r[2]+="%"),t+"("+r.join(",")+")"):e}),i.compatibility||h(/:([^;]*)(?:rgba|hsla)\(\d+,\d+%?,\d+%?,0\)/g,function(e,t){return(new Splitter(",")).split(e).pop().indexOf("gradient(")>-1?e:":"+t+"transparent"}),h(/outline:none/g,"outline:0"),h(/background:(?:none|transparent)([;}])/g,"background:0 0$1"),h(/box-shadow:0 0 0 0([^\.])/g,"box-shadow:0 0$1"),h(/:0 0 0 0([^\.])/g,":0$1"),h(/([: ,=\-])0\.(\d)/g,"$1.$2"),h(/rect\(\s?0(\s|,)0[ ,]0[ ,]0\s?\)/g,"rect(0$10$10$10)"),h(/\*([\.#:\[])/g,"$1"),h(/calc\([^\}]+\}/g,function(e){return e.replace(/\+/g," + ")}),i.compatibility||h(/([;\{])[\*_][\w\-]+:[^;\}]+/g,"$1"),i.noAdvanced?i.keepBreaks&&h(/\}/g,"}"+o):h(function(){e=(new SelectorsOptimizer(e,s,{keepBreaks:i.keepBreaks,lineBreak:o,compatibility:i.compatibility,aggressiveMerging:!i.noAggressiveMerging})).process()}),h(/(border-\w+-\w+-radius:\S+)\s+\/\s+/g,"$1/"),h(/(border-\w+-\w+-radius):([^;\}]+)/g,function(e,t,n){var r=n.split("/");return r.length>1&&r[0]==r[1]?t+":"+r[0]:e}),h(function(){e=l.restore(e)}),h(function(){e=i.noRebase?e:(new UrlRebase(i,s)).process(e)}),h(function(){e=f.restore(e)}),h(function(){e=u.restore(e)}),h(function(){e=a.restore(e)}),h(function(){var n=e.match(/@charset [^;]+;/),r=n?n[0]:null;if(!r)return;e=r+(i.keepBreaks?o:"")+e.replace(new RegExp("@charset [^;]+;("+o+")?","g"),"").trim()}),i.noAdvanced&&h(function(){e=(new EmptyRemoval(e)).process()}),e=e.trim();if(i.debug){var b=process.hrtime(n);r.timeSpent=~~(b[0]*1e3+b[1]/1e6),r.efficiency=1-e.length/r.originalSize,r.minifiedSize=e.length}return t?t.call(this,this.context.errors.length>0?this.context.errors:null,e):e};