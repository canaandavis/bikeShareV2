var Tokenizer=require("./tokenizer"),PropertyOptimizer=require("../properties/optimizer");module.exports=function(t,n,r){var i={"*":/\-(moz|ms|o|webkit)\-/,ie8:/(\-moz\-|\-ms\-|\-o\-|\-webkit\-|:root|:nth|:first\-of|:last|:only|:empty|:target|:checked|::selection|:enabled|:disabled|:not)/,ie7:/(\-moz\-|\-ms\-|\-o\-|\-webkit\-|:focus|:before|:after|:root|:nth|:first\-of|:last|:only|:empty|:target|:checked|::selection|:enabled|:disabled|:not)/},s=[],o=new PropertyOptimizer(r.compatibility,r.aggressiveMerging),u=function(e){if(e.indexOf(",")==-1)return e;var t=[],n=0,r=0,i=e.indexOf("(")==-1,s=function(t){if(i)return!1;var n=e.lastIndexOf("(",t),r=e.lastIndexOf(")",t);return n==-1?!1:r>0&&r<t?!1:!0};for(;;){var o=e.indexOf(",",n+1),u;if(o===-1)o=e.length;else if(s(o)){n=o+1;continue}u=e.substring(r,o),r=n=o+1,t.indexOf(u)==-1&&t.push(u);if(o===e.length)break}return t.sort().join(",")},a=function(e){return i[r.compatibility||"*"].test(e)},f=function(e){var t={},n=[];for(var r=0,i=e.length;r<i;r++){var o=e[r];if(typeof o=="string"||o.block)continue;var u=o.body+"@"+o.selector,a=t[u];a?(n.push(a[0]),a.unshift(r)):t[u]=[r]}n=n.sort(function(e,t){return e>t?1:-1});for(var f=0,l=n.length;f<l;f++)e.splice(n[f]-f,1);s.unshift(n.length>0)},l=function(e){var t=[],n={selector:null,body:null};for(var r=0,i=e.length;r<i;r++){var f=e[r];if(typeof f=="string"||f.block)continue;if(f.selector==n.selector){var l=[n.body.split(";").length];n.body=o.process(n.body+";"+f.body,l),t.push(r)}else f.body==n.body&&!a(f.selector)&&!a(n.selector)?(n.selector=u(n.selector+","+f.selector),t.push(r)):n=f}for(var c=0,h=t.length;c<h;c++)e.splice(t[c]-c,1);s.unshift(t.length>0)},c=function(e){var t={},n=[];for(var r=e.length-1;r>=0;r--){var i=e[r];if(typeof i=="string"||i.block)continue;var o=i.selector,u=o.indexOf(",")>-1&&!a(o)?o.split(",").concat(o):[o];for(var f=0,l=u.length;f<l;f++){var c=u[f];t[c]?n.push(c):t[c]=[],t[c].push({where:r,partial:c!=o})}}var d=h(e,n,t),v=p(e,t);s.unshift(d||v)},h=function(e,t,n){var r=!1;for(var i=0,s=t.length;i<s;i++){var o=t[i],u=n[o];if(u.length<2)continue;d(e,o,u,{filterOut:function(e,t){return u[e].partial&&t.length===0},callback:function(e,t,n,i){u[n-i-1].partial||(e.body=t.join(";"),r=!0)}})}return r},p=function(e,t){var n=!1;e:for(var r in t){if(r.indexOf(",")==-1)continue;var i=t[r].pop().where,s=e[i],o=a(r)?[r]:r.split(","),u=[];for(var f=0,l=o.length;f<l;f++){var c=o[f],h=t[c];if(h.length<2)continue e;d(e,c,h,{filterOut:function(e){return h[e].where<i},callback:function(e,t,n,r){r===0&&u.push(t.join(";"))}});if(u[u.length-1]!=u[0])continue e}s.body=u[0],n=!0}return n},d=function(e,t,n,r){var i=[],s=[],u=[],a=[];for(var f=n.length-1,l=0;f>=0;f--){if(r.filterOut(f,i))continue;var c=n[f].where,h=e[c],p=h.body;i.push(p),u.push(p.split(";")),a.push(c)}for(f=0,l=i.length;f<l;f++)i[f].length>0&&s.push((s[f-1]||0)+u[f].length);var d=o.process(i.join(";"),s,!0),v=d.split(";"),m=a.length,g=v.length-1,y=m-1;while(y>=0){if((y===0||u[y].indexOf(v[g])>-1)&&g>-1){g--;continue}var b=v.splice(g+1);r.callback(e[a[y]],b,m,y),y--}},v=function(e){var t=function(){return s.length>4&&s[0]===!1&&s[1]===!1};e=Array.isArray(e)?e:[e];for(var n=0,r=e.length;n<r;n++){var i=e[n];i.selector?(i.selector=u(i.selector),i.body=o.process(i.body,!1)):i.block&&v(i.body)}s=[];for(;;){if(t())break;f(e);if(t())break;l(e);if(t())break;c(e)}},m=function(e){var t=[];e=Array.isArray(e)?e:[e];for(var n=0,i=e.length;n<i;n++){var s=e[n];if(typeof s=="string"){t.push(s);continue}var o=s.block||s.selector,u=s.block?m(s.body):s.body;u.length>0&&t.push(o+"{"+u+"}")}return t.join(r.keepBreaks?r.lineBreak:"")};return{process:function(){var e=(new Tokenizer(t,n)).process();return v(e),m(e)}}};