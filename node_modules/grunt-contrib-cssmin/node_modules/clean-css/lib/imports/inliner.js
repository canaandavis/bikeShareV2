var fs=require("fs"),path=require("path"),http=require("http"),https=require("https"),url=require("url"),UrlRewriter=require("../images/url-rewriter"),merge=function(e,t){var n={};for(var r in e)n[r]=e[r];for(var i in t)n[i]=t[i];return n};module.exports=function(t,n){var r={timeout:5e3,request:{}},i=merge(r,n||{}),s=function(e,t){if(t.shallow)return t.shallow=!1,t._shared.done.push(e),o(t);t._shared=t._shared||{done:[],left:[]};var n=t._shared,r=0,i=0,s=0,l=u(e),c=a(e);t.relativeTo=t.relativeTo||t.root,t._baseRelativeTo=t._baseRelativeTo||t.relativeTo,t.visited=t.visited||[];for(;i<e.length;){r=e.indexOf("@import",s);if(r==-1)break;if(l(r)){s=r+1;continue}i=e.indexOf(";",r);if(i==-1){s=e.length,e="";break}return n.done.push(e.substring(0,r)),n.left.unshift([e.substring(i+1),t]),c(r)?o(t):f(e,r,i,t)}return n.done.push(e),o(t)},o=function(e){return e._shared.left.length>0?s.apply(null,e._shared.left.shift()):e.whenDone(e._shared.done.join(""))},u=function(e){var t=/(\/\*(?!\*\/)[\s\S]*?\*\/)/,n=0,r=0,i=!1,s=function(o){var u,a=0,f=0,l=0,c=0;return i?!1:o>n&&o<r?!0:(u=e.match(t),u?(n=a=u.index,f=a+u[0].length,c=f+r,l=c-u[0].length,e=e.substring(f),r=c,c<o?s(o):c>o&&o>l):(i=!0,!1))};return s},a=function(e){var t=u(e),n=-1;for(;;){n=e.indexOf("{",n+1);if(n==-1||!t(n))break}return function(e){return n>-1?e>n:!1}},f=function(e,n,r,i){i.shallow=e.indexOf("@shallow")>0;var s=e.substring(e.indexOf(" ",n)+1,r).replace(/@shallow\)$/,")").trim(),u=s.indexOf("url(")===0,a=u?4:0,f=/^['"]/.exec(s.substring(a,a+2)),p=f?s.indexOf(f[0],a+1):s.split(" ")[0].length,d=s.substring(a,p).replace(/['"]/g,"").replace(/\)$/,"").trim(),v=s.substring(p+1).replace(/^\)/,"").trim(),m=i.isRemote||/^(http|https):\/\//.test(d)||/^\/\//.test(d);if(i.localOnly&&m)return t.warnings.push('Ignoring remote @import declaration of "'+d+'" as no callback given.'),h(d,v,i),o(i);var g=m?l:c;return g(d,v,i)},l=function(e,n,r){var u=/^https?:\/\//.test(e)?e:url.resolve(r.relativeTo,e);u.indexOf("//")===0&&(u="http:"+u);if(r.visited.indexOf(u)>-1)return o(r);t.debug&&console.error("Inlining remote stylesheet: "+u),r.visited.push(u);var a=u.indexOf("http://")===0?http.get:https.get,f=!1,c=function(e){t.errors.push('Broken @import declaration of "'+u+'" - '+e),h(u,n,r),o(r)},p=merge(url.parse(u),i.request);a(p,function(e){if(e.statusCode<200||e.statusCode>399)return c("error "+e.statusCode);if(e.statusCode>299){var t=url.resolve(u,e.headers.location);return l(t,n,r)}var i=[],o=url.parse(u);e.on("data",function(e){i.push(e.toString())}),e.on("end",function(){var e=i.join("");e=UrlRewriter.process(e,{toBase:u}),n.length>0&&(e="@media "+n+"{"+e+"}"),s(e,{isRemote:!0,relativeTo:o.protocol+"//"+o.host,_shared:r._shared,whenDone:r.whenDone,visited:r.visited,shallow:r.shallow})})}).on("error",function(e){c(e.message)}).on("timeout",function(){if(f)return;c("timeout"),f=!0}).setTimeout(i.timeout)},c=function(e,n,r){var i=e[0]=="/"?r.root:r.relativeTo,u=path.resolve(path.join(i,e));if(!fs.existsSync(u)||!fs.statSync(u).isFile())return t.errors.push('Broken @import declaration of "'+e+'"'),o(r);if(r.visited.indexOf(u)>-1)return o(r);t.debug&&console.error("Inlining local stylesheet: "+u),r.visited.push(u);var a=fs.readFileSync(u,"utf8"),f=path.dirname(u);return a=UrlRewriter.process(a,{relative:!0,fromBase:f,toBase:r._baseRelativeTo}),n.length>0&&(a="@media "+n+"{"+a+"}"),s(a,{root:r.root,relativeTo:f,_baseRelativeTo:r._baseRelativeTo,_shared:r._shared,visited:r.visited,whenDone:r.whenDone,localOnly:r.localOnly,shallow:r.shallow})},h=function(e,t,n){var r="@import url("+e+")"+(t.length>0?" "+t:"")+";";n._shared.done.push(r)};return{process:s}};